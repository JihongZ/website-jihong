{
  "hash": "7f0020bce8e533dacd9ec2341763e09d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Web Scraping Academia Institute's Grant Fundings using R\ndescription: \"How to use R for web scrapping\"\nauthor: 'Jihong Zhang'\ndate: '2022-05-12'\nslug: web-scrapping-grant-fundings-in-r\ncategories:\n  - blog\n  - Web Scrapping\ntags: []\nsubtitle: ''\nsummary: ''\nlastmod: '2022-05-12T21:38:27-05:00'\nfeatured: no\nprojects: []\n---\n\n\nThis is an example of how to web scrape grants of active research in college's official website. Please follow the academia institute's website robots rules.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(XML)\nlibrary(stringr)\nlibrary(rvest)\nlibrary(tidyverse)\nlibrary(kableExtra)\n```\n:::\n\n\n## Web Scrapping\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntopics = rep(NA, 84)\nfundings = rep(NA, 84)\niter = 0\nfor (page in 1:9) {\n  ## parent webpage\n  scrape_url <- paste0('http://XXXXXXXXXXXXXXXXXXXXXX', page)\n  \n  html_form_page <- read_html(scrape_url)\n  \n  ## find the child web page containing projects' name, total award, topic etc.\n  child_url = html_form_page |> html_elements(\"h3 a[href]\") |> html_attr(\"href\") \n  \n  for (item in 1:length(child_url)) {\n    iter = iter + 1\n    child_html_text <- child_url[item] |> read_html() |> html_elements(\"div[class='study_wrapper']\") |> html_text() \n    topic = child_html_text |> str_extract(pattern = \"Topic\\\\(s\\\\)\\\\: [a-zA-Z]+\\\\b\") |> str_replace(pattern = \"Topic\\\\(s\\\\)\\\\: \", \"\")\n    funding = child_html_text |> str_extract(pattern = \"\\\\$\\\\d+\\\\,\\\\d+\") |> str_replace_all(pattern = \"\\\\$|\\\\,\", \"\") |> as.numeric()\n    topics[iter] = topic\n    fundings[iter] = funding\n  }\n}\n\ndat <- data.frame(topic = topics, funding_amount = fundings) |> \n  add_row(topic = \"Marijuana\", funding_amount = 3743) |> \n  mutate(topic = ifelse(topic == \"TobaccoMarijuana\", \"Tobacco\", topic)) \n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-material\" style='font-family: \"Source Sans Pro\", helvetica, sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> topic </th>\n   <th style=\"text-align:right;\"> funding_amount </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Other </td>\n   <td style=\"text-align:right;\"> 97666 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Other </td>\n   <td style=\"text-align:right;\"> 15000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Tobacco </td>\n   <td style=\"text-align:right;\"> 1271 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Cancer </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Other </td>\n   <td style=\"text-align:right;\"> 199836 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Other </td>\n   <td style=\"text-align:right;\"> 64614 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Cancer </td>\n   <td style=\"text-align:right;\"> 200000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Other </td>\n   <td style=\"text-align:right;\"> 75000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Other </td>\n   <td style=\"text-align:right;\"> 72972 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Cancer </td>\n   <td style=\"text-align:right;\"> 329234 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Visualization in ggplot2\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## funding per project\ndat1 <- dat |> \n  group_by(topic) |> \n  summarise(funding_amount_mean = mean(funding_amount, na.rm = T)) |> \n  mutate(topic = fct_reorder(topic, desc(funding_amount_mean)))\n\nggplot(dat1) +\n  aes(x = topic, y = funding_amount_mean) +\n  geom_col(fill = \"darkblue\") +\n  scale_y_continuous(labels = scales::unit_format(unit = \"M\", scale = 1e-6)) +\n  labs(y = \"funding per project\", title = \"Funding for each project during 2019 to 2022\") +\n  theme(legend.position = \"none\", text = element_text(size = 12)) # remove lengend\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=672}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## Total funding amount\ndat2 <- dat |> \n  group_by(topic) |> \n  summarise(\n    funding_amount_sum = sum(funding_amount, na.rm = T), \n    n = n()) |> \n  mutate(\n    topic = fct_reorder(topic, desc(funding_amount_sum)),\n    highlight = ifelse(funding_amount_sum == max(funding_amount_sum), 1, 0) |> as.factor())\n\nggplot(dat2) +\n  aes(x = topic, y = funding_amount_sum, fill = highlight) +\n  geom_col() +\n  geom_text(aes(label = round(funding_amount_sum/ 10^6, 3)), vjust = 0.001, size = 5) +\n  geom_label(aes(label = n), vjust = 0.999, size = 5, color = \"white\") +\n  scale_fill_manual(values = c(\"darkblue\", \"red2\")) +\n  labs(x = \"\", y = \"total amount of funding\", \n       title = \"Total Amount of Funding and Number of Grant Projects during 2019-2022\", \n       subtitle = \"Active research at Health Promotion Center from 2019 to 2022\",\n       caption = \"source: https://healthpromotionresearch.org/Active-Studies/\") +\n  scale_y_continuous(labels = scales::unit_format(unit = \"M\", scale = 1e-6)) +\n  theme(legend.position = \"none\", text = element_text(size = 10)) # remove lengend\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){fig-align='center' width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}