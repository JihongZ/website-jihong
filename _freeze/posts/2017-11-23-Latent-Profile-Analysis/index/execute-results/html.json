{
  "hash": "e6581fed85d298f9afc8d1f5aeee3155",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Latent Profile Analysis using MCLUST (in R)\nauthor: Jihong Zhang\ndate: '2017-11-23'\ncategories:\n  - R\n  - clustering\n  - latent class\n---\n\n\nHi there! This is Jihong. This is a webpage folked from [JOSHUA M. ROSENBERG](https://jrosen48.github.io/blog/lpa-in-r-using-mclust/). It aims to provid a very clear example about how to conduct Latent Profile Analysis using MCLUST in r.\n\n# Import data and load packages\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(mclust)\nlibrary(hrbrthemes) # typographic-centric ggplot2 themes\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(\"iris\")\ndf <- select(iris, -Species) # 4 variables\n\nexplore_model_fit <- function(df, n_profiles_range = 1:9, \n                              model_names = c(\"EII\", \"VVI\", \"EEE\", \"VVV\")) {\n    x <- mclustBIC(df, G = n_profiles_range, modelNames = model_names)\n    y <- x %>%\n        as.data.frame.matrix() %>%\n        rownames_to_column(\"n_profiles\") %>%\n        rename(`Constrained variance, fixed covariance` = EII, \n               `Freed variance, fixed covariance` = VVI,\n               `Constrained variance, constrained covariance` = EEE,\n               `Freed variance, freed covariance` = VVV)\n    y\n}\n\nfit_output <- explore_model_fit(df, n_profiles_range = 1:6)\n\nlibrary(forcats)\n\nto_plot <- fit_output %>%\n    gather(`Covariance matrix structure`, val, -n_profiles) %>% \n    mutate(\n      `Covariance matrix structure` = as.factor(`Covariance matrix structure`\n                                                ),\n      val = abs(val)) \n# this is to make the BIC values positive (to align with more common formula / interpretation of BIC)\n\n\nggplot(to_plot, aes(x = n_profiles, y = val, color = `Covariance matrix structure`, group = `Covariance matrix structure`)) +\n    geom_line() +\n    geom_point() +\n    ylab(\"BIC (smaller value is better)\") +\n    theme_ipsum_rc()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nFrom red to purple, the models become less constrained (more free). It appears that a two or three profile (mixture component) model with freely-estimated residual variances and covariances, or a four profile model with constrained residual covariances and variances, fit best (based on interpreting the BIC).\n\nGiven this, we can fit (and inspect) a model, say, the three profile model with freely-estimated residual variance and covariances.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncreate_profiles_mclust <- function(df,\n                                   n_profiles, \n                                   variance_structure = \"freed\",\n                                   covariance_structure = \"freed\"){\n    \n    if (variance_structure == \"constrained\" & covariance_structure == \"fixed\") {\n        \n        model_name <- \"EEI\"\n        \n    } else if (variance_structure == \"freed\" & covariance_structure == \"fixed\") {\n        \n        model_name <- \"VVI\"\n        \n    } else if (variance_structure == \"constrained\" & covariance_structure == \"constrained\") {\n        \n        model_name <- \"EEE\"\n        \n    } else if (variance_structure == \"freed\" & covariance_structure == \"freed\") {\n        \n        model_name <- \"VVV\"\n        \n    } else if (variance_structure == \"fixed\") {\n        \n        stop(\"variance_structure cannot equal 'fixed' using this function; change this to 'constrained' or 'freed' or try one of the models from mclust::Mclust()\")\n        \n    } \n    \n    x <- Mclust(df, G = n_profiles, modelNames = model_name)\n    \n    print(summary(x))\n    \n    dff <- bind_cols(df, classification = x$classification)\n    \n    proc_df <- dff %>%\n        mutate_at(vars(-classification), scale) %>%\n        group_by(classification) %>%\n        summarize_all(funs(mean)) %>%\n        mutate(classification = paste0(\"Profile \", 1:n_profiles)) %>%\n        mutate_at(vars(-classification), function(x) round(x, 3)) %>%\n        rename(profile = classification)\n    \n    return(proc_df)\n    \n}\n\nm3 <- create_profiles_mclust(df, 3, variance_structure = \"freed\", covariance_structure = \"freed\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n---------------------------------------------------- \nGaussian finite mixture model fitted by EM algorithm \n---------------------------------------------------- \n\nMclust VVV (ellipsoidal, varying volume, shape, and orientation) model with 3\ncomponents: \n\n log-likelihood   n df       BIC       ICL\n      -180.1858 150 44 -580.8396 -584.0522\n\nClustering table:\n 1  2  3 \n50 45 55 \n```\n\n\n:::\n:::\n\n\nWe can then plot the mean values for the variables used to estimate the model for each of the two profiles. Of course, there are other models that we may want to inspect with different covariance matrix structures or profile numbers.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm3 %>%\n    gather(key, val, -profile) %>% \n    ggplot(aes(x = profile, y = val, fill = key, group = key)) +\n    geom_col(position = \"dodge\") +\n    ylab(\"Z-score\") +\n    xlab(\"\") +\n    scale_fill_discrete(\"\") +\n    theme_ipsum_rc()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nOne big question: Are the residual covariance structures correctly specified? There are a lot of possible specifications (see help file here). I think they are right, based on their definitions, inspecting their covariance matrices, and inspecting their plots. But they might not be.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}